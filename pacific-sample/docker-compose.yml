version: "3.8"

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15
    container_name: ncm-sample-postgres
    environment:
      POSTGRES_USER: auth_user
      POSTGRES_PASSWORD: auth_password
      POSTGRES_DB: auth_service
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U auth_user -d test"]
      interval: 10s
      timeout: 5s
      retries: 5

  keycloak:
    image: quay.io/keycloak/keycloak:22.0
    container_name: auth-service-keycloak
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin123
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/auth_service
      KC_DB_USERNAME: auth_user
      KC_DB_PASSWORD: auth_password
      KC_HOSTNAME_STRICT: false
      KC_HOSTNAME_STRICT_HTTPS: false
      KC_HTTP_ENABLED: true
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true
      KC_LOG_LEVEL: INFO
      KC_PROXY: edge
      KC_HOSTNAME: localhost
      KC_HOSTNAME_PORT: 8080
    ports:
      - "8080:8080"
    volumes:
      - ./docker/keycloak/realm-config:/opt/keycloak/data/import
    depends_on:
      postgres:
        condition: service_healthy
    command: start-dev --import-realm
    healthcheck:
      test:
        ["CMD-SHELL", "curl -f http://localhost:8080/health/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: ncm-sample-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Kafka
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: ncm-sample-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: ncm-sample-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    healthcheck:
      test:
        [
          "CMD",
          "kafka-topics",
          "--bootstrap-server",
          "localhost:9092",
          "--list",
        ]
      interval: 30s
      timeout: 10s
      retries: 5

  # OpenAM (ForgeRock)
  # openam:
  #   image: openidentityplatform/openam:latest
  #   container_name: ncm-sample-openam
  #   ports:
  #     - "8080:8080"
  #   environment:
  #     - SERVER_URL=http://localhost:8080
  #     - ADMIN_PWD=password
  #     - AMADMIN_PWD=password
  #   volumes:
  #     - openam_data:/opt/openam
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8080/openam/"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 10
  #     start_period: 60s

  # NCM Sample Application
  # ncm-sample:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   container_name: ncm-sample-app
  #   ports:
  #     - "8000:8000"
  #   environment:
  #     - DATABASE_URL=postgresql://auth_user:auth_password@postgres:5432/test
  #     - REDIS_URL=redis://redis:6379
  #     - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
  #     - OPENAM_URL=http://openam:8080/openam
  #     - SECRET_KEY=sample-secret-key-change-in-production
  #     - JWT_SECRET=sample-jwt-secret-change-in-production
  #     - LOG_LEVEL=INFO
  #     - LOG_FORMAT=json
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #     kafka:
  #       condition: service_healthy
  #     openam:
  #       condition: service_healthy
  #   volumes:
  #     - ./src:/app/src
  #     - ./migrations:/app/migrations
  #   command:
  #     [
  #       "python",
  #       "-m",
  #       "uvicorn",
  #       "ncm_sample.api:app",
  #       "--host",
  #       "0.0.0.0",
  #       "--port",
  #       "8000",
  #       "--reload",
  #     ]

volumes:
  postgres_data:
  redis_data:

networks:
  default:
    name: ncm-sample-network
